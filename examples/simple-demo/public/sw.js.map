{
  "version": 3,
  "sources": ["../../../packages/client/src/sw.ts"],
  "sourcesContent": ["/// <reference lib=\"webworker\" />\nimport { TunnelRequest, TunnelResponse } from \"@http-over-webrtc/shared\";\n\ndeclare const self: ServiceWorkerGlobalScope;\n\nself.addEventListener(\"install\", (event) => {\n    console.log(\"[SW] Installed\");\n    event.waitUntil(self.skipWaiting());\n});\n\nself.addEventListener(\"activate\", (event) => {\n    console.log(\"[SW] Activated\");\n    event.waitUntil(self.clients.claim());\n});\n\nself.addEventListener(\"fetch\", (event) => {\n    const url = new URL(event.request.url);\n    if (url.pathname.startsWith(\"/p2p/\")) {\n        event.respondWith(handleRequest(event.request));\n    }\n});\n\nasync function handleRequest(request: Request): Promise<Response> {\n    const clients = await self.clients.matchAll({ type: \"window\", includeUncontrolled: true });\n    // We try to find the client that initiated this request, or fallback to the first one\n    const client = (clients.length > 0 ? clients[0] : null) as Client | null;\n\n    if (!client) {\n        return new Response(\"No client connected to SW\", { status: 503 });\n    }\n\n    const requestId = crypto.randomUUID();\n    let body = null;\n    if (request.method !== \"GET\" && request.method !== \"HEAD\") {\n        try {\n            // Simple serialization: JSON if possible, else text\n            const contentType = request.headers.get(\"Content-Type\") || \"\";\n            if (contentType.includes(\"application/json\")) {\n                body = await request.json();\n            } else {\n                body = await request.text();\n            }\n        } catch (e) {\n            console.warn(\"[SW] Failed to serialize body\", e);\n        }\n    }\n\n    const tunnelRequest: TunnelRequest = {\n        type: \"TUNNEL_REQUEST\",\n        requestId,\n        method: request.method,\n        url: request.url,\n        headers: Object.fromEntries(request.headers.entries()),\n        body: body\n    };\n\n    return new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n            self.removeEventListener(\"message\", handler);\n            resolve(new Response(\"Gateway Timeout: Bridge did not respond\", { status: 504 }));\n        }, 5000);\n\n        const handler = (event: ExtendableMessageEvent) => {\n            const data = event.data as TunnelResponse;\n            if (data.type === \"TUNNEL_RESPONSE\" && data.requestId === requestId) {\n                clearTimeout(timeout);\n                self.removeEventListener(\"message\", handler);\n                resolve(new Response(data.body, {\n                    status: data.status,\n                    statusText: data.statusText,\n                    headers: data.headers\n                }));\n            }\n        };\n        self.addEventListener(\"message\", handler);\n\n        client.postMessage(tunnelRequest);\n    });\n}\n"],
  "mappings": ";;;AAKA,OAAK,iBAAiB,WAAW,CAAC,UAAU;AACxC,YAAQ,IAAI,gBAAgB;AAC5B,UAAM,UAAU,KAAK,YAAY,CAAC;AAAA,EACtC,CAAC;AAED,OAAK,iBAAiB,YAAY,CAAC,UAAU;AACzC,YAAQ,IAAI,gBAAgB;AAC5B,UAAM,UAAU,KAAK,QAAQ,MAAM,CAAC;AAAA,EACxC,CAAC;AAED,OAAK,iBAAiB,SAAS,CAAC,UAAU;AACtC,UAAM,MAAM,IAAI,IAAI,MAAM,QAAQ,GAAG;AACrC,QAAI,IAAI,SAAS,WAAW,OAAO,GAAG;AAClC,YAAM,YAAY,cAAc,MAAM,OAAO,CAAC;AAAA,IAClD;AAAA,EACJ,CAAC;AAED,iBAAe,cAAc,SAAqC;AAC9D,UAAM,UAAU,MAAM,KAAK,QAAQ,SAAS,EAAE,MAAM,UAAU,qBAAqB,KAAK,CAAC;AAEzF,UAAM,SAAU,QAAQ,SAAS,IAAI,QAAQ,CAAC,IAAI;AAElD,QAAI,CAAC,QAAQ;AACT,aAAO,IAAI,SAAS,6BAA6B,EAAE,QAAQ,IAAI,CAAC;AAAA,IACpE;AAEA,UAAM,YAAY,OAAO,WAAW;AACpC,QAAI,OAAO;AACX,QAAI,QAAQ,WAAW,SAAS,QAAQ,WAAW,QAAQ;AACvD,UAAI;AAEA,cAAM,cAAc,QAAQ,QAAQ,IAAI,cAAc,KAAK;AAC3D,YAAI,YAAY,SAAS,kBAAkB,GAAG;AAC1C,iBAAO,MAAM,QAAQ,KAAK;AAAA,QAC9B,OAAO;AACH,iBAAO,MAAM,QAAQ,KAAK;AAAA,QAC9B;AAAA,MACJ,SAAS,GAAG;AACR,gBAAQ,KAAK,iCAAiC,CAAC;AAAA,MACnD;AAAA,IACJ;AAEA,UAAM,gBAA+B;AAAA,MACjC,MAAM;AAAA,MACN;AAAA,MACA,QAAQ,QAAQ;AAAA,MAChB,KAAK,QAAQ;AAAA,MACb,SAAS,OAAO,YAAY,QAAQ,QAAQ,QAAQ,CAAC;AAAA,MACrD;AAAA,IACJ;AAEA,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACpC,YAAM,UAAU,WAAW,MAAM;AAC7B,aAAK,oBAAoB,WAAW,OAAO;AAC3C,gBAAQ,IAAI,SAAS,2CAA2C,EAAE,QAAQ,IAAI,CAAC,CAAC;AAAA,MACpF,GAAG,GAAI;AAEP,YAAM,UAAU,CAAC,UAAkC;AAC/C,cAAM,OAAO,MAAM;AACnB,YAAI,KAAK,SAAS,qBAAqB,KAAK,cAAc,WAAW;AACjE,uBAAa,OAAO;AACpB,eAAK,oBAAoB,WAAW,OAAO;AAC3C,kBAAQ,IAAI,SAAS,KAAK,MAAM;AAAA,YAC5B,QAAQ,KAAK;AAAA,YACb,YAAY,KAAK;AAAA,YACjB,SAAS,KAAK;AAAA,UAClB,CAAC,CAAC;AAAA,QACN;AAAA,MACJ;AACA,WAAK,iBAAiB,WAAW,OAAO;AAExC,aAAO,YAAY,aAAa;AAAA,IACpC,CAAC;AAAA,EACL;",
  "names": []
}
